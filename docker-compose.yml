services:
  postgres:
    image: postgres:16
    environment:
      POSTGRES_DB: worldmind
      POSTGRES_USER: worldmind
      POSTGRES_PASSWORD: worldmind
    ports:
      - "5432:5432"
    volumes:
      - pgdata:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U worldmind"]
      interval: 5s
      timeout: 5s
      retries: 5

  nexus:
    image: ${NEXUS_IMAGE:-ghcr.io/dbbaskette/nexus:latest}
    ports:
      - "8090:8090"
    volumes:
      - nexus-data:/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8090/health"]
      interval: 10s
      timeout: 5s
      retries: 3
    # Only started when Nexus is needed
    profiles:
      - nexus
      - full

  worldmind:
    build: .
    ports:
      - "${WORLDMIND_PORT:-8080}:8080"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - workspace:/workspace
    environment:
      SPRING_PROFILES_ACTIVE: ${WORLDMIND_PROFILE:-local}
      DATABASE_URL: jdbc:postgresql://postgres:5432/worldmind
      DB_USER: worldmind
      DB_PASSWORD: worldmind
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY:-not-set}
      GOOGLE_API_KEY: ${GOOGLE_API_KEY:-not-set}
      LOCAL_LLM_URL: ${LOCAL_LLM_URL:-http://host.docker.internal:1234}
      LOCAL_LLM_MODEL: ${LOCAL_LLM_MODEL:-qwen/qwen3-coder-30b}
      GOOSE_PROVIDER: ${GOOSE_PROVIDER:-openai}
      GOOSE_MODEL: ${GOOSE_MODEL:-qwen2.5-coder-32b}
      WORKSPACE_VOLUME: worldmind-workspace
      # Nexus MCP Gateway
      NEXUS_ENABLED: ${NEXUS_ENABLED:-false}
      NEXUS_URL: ${NEXUS_URL:-http://nexus:8090/mcp}
      NEXUS_CORE_CLASSIFY_TOKEN: ${NEXUS_CORE_CLASSIFY_TOKEN:-}
      NEXUS_CORE_UPLOAD_TOKEN: ${NEXUS_CORE_UPLOAD_TOKEN:-}
      NEXUS_CORE_PLAN_TOKEN: ${NEXUS_CORE_PLAN_TOKEN:-}
      NEXUS_CORE_SCHEDULE_TOKEN: ${NEXUS_CORE_SCHEDULE_TOKEN:-}
      NEXUS_CORE_CONVERGE_TOKEN: ${NEXUS_CORE_CONVERGE_TOKEN:-}
      NEXUS_CORE_SEAL_TOKEN: ${NEXUS_CORE_SEAL_TOKEN:-}
      NEXUS_CORE_POSTMISSION_TOKEN: ${NEXUS_CORE_POSTMISSION_TOKEN:-}
      NEXUS_CENTURION_FORGE_TOKEN: ${NEXUS_CENTURION_FORGE_TOKEN:-}
      NEXUS_CENTURION_GAUNTLET_TOKEN: ${NEXUS_CENTURION_GAUNTLET_TOKEN:-}
      NEXUS_CENTURION_PRISM_TOKEN: ${NEXUS_CENTURION_PRISM_TOKEN:-}
      NEXUS_CENTURION_VIGIL_TOKEN: ${NEXUS_CENTURION_VIGIL_TOKEN:-}
      NEXUS_CENTURION_PULSE_TOKEN: ${NEXUS_CENTURION_PULSE_TOKEN:-}
    depends_on:
      postgres:
        condition: service_healthy
    # Only used with `docker compose up worldmind`
    # For local dev, run.sh starts the JAR directly
    profiles:
      - full

volumes:
  pgdata:
  nexus-data:
  workspace:
    name: worldmind-workspace
